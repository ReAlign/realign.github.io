---
view: post
layout: post
lang: zh-cn
author: realign
title: Lerna-å¦‚ä½•ä¼˜é›…åœ°ç®¡ç†å¤šä¸ªnpmåŒ…
description: Lerna-å¦‚ä½•ä¼˜é›…åœ°ç®¡ç†å¤šä¸ªnpmåŒ…
excerpt: Lerna-å¦‚ä½•ä¼˜é›…åœ°ç®¡ç†å¤šä¸ªnpmåŒ…
cover: true
coverConfig:
  - type: git
  - iconType: git
  - title: Lerna
  - subTitle: Manage multiple npm pkg
categories:
  - node
  - automation
  - notes
tags:
  - node
  - npm
  - lerna
  - multiple
created_at: 2019-12-19 11:03
updated_at: 2019-12-19 11:03
meta:
  - name: keywords
    content: node,automation,notes,npm,lerna,multiple
---

---

## å…³äº Lerna

[lerna å®˜ç½‘](https://lerna.js.org/) å¯¹äº `lerna` çš„ä¸¤æ®µæè¿°ï¼š

> A tool for managing JavaScript projects with multiple packages.

> Lerna is a tool that optimizes the workflow around managing multi-package repositories with git and npm.

ç®€å•ç¿»è¯‘ä¸‹ï¼š

> `Lerna` åŸºäº **GIT**(ä¸»è¦æ˜¯ commit) å’Œ **NPM**(å·¥å…·é“¾) æ¥**è¾…åŠ©**å’Œ**ä¼˜åŒ–**å¼€å‘è€…ç®¡ç†å¤šåŒ…ã€‚

ç¿»è¯‘ä¹‹åï¼Œè¿˜æ˜¯ä¸€è„¸æ‡µå§ ğŸ˜‚ã€‚é‚£å°±å¯¹äº†ï¼Œæ²¡æœ‰å®é™…åœºæ™¯ï¼Œé¬¼æ‰çŸ¥é“è¿™æ˜¯å¹²å˜›çš„ï¼Œæ¥å¾€ä¸‹èµ°~

## åœºæ™¯

ä¸‹é¢æˆ‘ä»¬æ¥é€šè¿‡ä¸€ä¸ªå…¸å‹åœºæ™¯æ¥åˆ†æ `lerna` èƒ½è§£å†³ä»€ä¹ˆå®é™…çš„ç—›ç‚¹ã€‚

### å…¸å‹åœºæ™¯æè¿°

- æœ‰ä¸€ä¸ªä¸šåŠ¡ç»„ä»¶ä»“åº“ï¼Œé‡Œè¾¹æœ‰ **N ä¸ª** ä¸šåŠ¡ç»„ä»¶
- æ¯ä¸ªä¸šåŠ¡ç»„ä»¶æ˜¯ä¸€ä¸ª **å•ç‹¬** çš„ npm åŒ…
- ä½œä¸ºä¸€ä¸ª **åŒ…ç®¡ç†è€…**
- æ¯ä¸€æ¬¡ä»“åº“çš„æ›´æ–°ï¼Œéƒ½æ„å‘³ææœ‰å¯èƒ½éœ€è¦å‘ä¸€éåŒ…

é‚£ä¹ˆï¼Œé—®é¢˜æ¥äº†ï¼š

1. æ€ä¹ˆçŸ¥é“å“ªäº›åŒ…æœ‰æ”¹åŠ¨ï¼Ÿ
2. è¿™äº›æ”¹åŠ¨æ˜¯å¦éƒ½éœ€è¦å‘ç‰ˆï¼Ÿ
3. éœ€è¦å‘ç‰ˆçš„åŒ…æ–°çš„ç‰ˆæœ¬å·è°æ¥æ›´æ–°ï¼Œç‰ˆæœ¬å·æ€ä¹ˆå¤„ç†ï¼Ÿ
   - majorï¼Ÿ
   - premajorï¼Ÿ
   - minorï¼Ÿ
   - othersï¼Ÿ
4. å¼€å‘è€…å¿˜è®°ç»´æŠ¤é™¤åŒ…æ ¸å¿ƒé€»è¾‘ä¹‹å¤–çš„ä¸€äº›ä¸œè¥¿æ€ä¹ˆåŠï¼Ÿæ¯”å¦‚ï¼š
   - version
   - changeLog
5. å‘åŒ…éœ€è¦æœºæ¢°åœ°é‡å¤æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å—ï¼Ÿ
   - `cd xxx`
   - `npm publish`
6. ç­‰

çœ‹ç€è¿™ä¸€å †é—®é¢˜ï¼Œæ˜¯ä¸æ˜¯è§‰å¾—ï¼Œè¿™ä¸ªåŒ…ç®¡ç†è€…ï¼Œä¸å½“ä¹Ÿç½¢~ å†æ¬¡ ğŸ˜‚

### åœºæ™¯é—®é¢˜åˆ†æ

è¿™äº›é—®é¢˜ï¼Œå…ˆçœ‹çœ‹ `lerna` æ˜¯åŸºäºä»€ä¹ˆè§£å†³çš„ï¼Œç„¶åï¼Œæˆ‘ä»¬å†å¼€å§‹æ·±å…¥äº†è§£ `lerna`ã€‚

1. æ€ä¹ˆçŸ¥é“å“ªäº›åŒ…æœ‰æ”¹åŠ¨ï¼Ÿ
   - ä¸æ˜¯æœ‰ git commit å˜›
2. è¿™äº›æ”¹åŠ¨æ˜¯å¦éƒ½éœ€è¦å‘ç‰ˆï¼Ÿ
   - ä½ å¯ä»¥åœ¨ä¸€ä¸ªé…ç½®ä¸­æŒ‡å®šéœ€è¦å…³æ³¨çš„æ–‡ä»¶
3. éœ€è¦å‘ç‰ˆçš„åŒ…æ–°çš„ç‰ˆæœ¬å·è°æ¥æ›´æ–°ï¼Œç‰ˆæœ¬å·æ€ä¹ˆå¤„ç†ï¼Ÿ
   - ä¸å°±æ˜¯æ‹‰å–ç°æœ‰ç‰ˆæœ¬å·ï¼Œç„¶ååŸºäº npm semver æ¥æ›´æ–°å˜›
4. å¼€å‘è€…å¿˜è®°ç»´æŠ¤é™¤åŒ…æ ¸å¿ƒé€»è¾‘ä¹‹å¤–çš„ä¸€äº›ä¸œè¥¿æ€ä¹ˆåŠï¼Ÿ
   - å†è¯´ä¸€éï¼Œä¸æ˜¯æœ‰ git commit å˜›
5. å‘åŒ…éœ€è¦æœºæ¢°åœ°é‡å¤æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å—ï¼Ÿ
   - è¿™ä¹ˆæœ‰è§„å¾‹çš„æ“ä½œï¼Œä¸å°±æ˜¯äº¤ç»™æœºå™¨åšçš„å˜›

### Lerna çš„å¤„ç†æœºåˆ¶

`Lerna` å¯¹äºåŒ…çš„ç®¡ç†ï¼Œæœ‰ä¸¤ç§æ¨¡å¼ï¼šå›ºå®šæ¨¡å¼(fixed)ã€ç‹¬ç«‹æ¨¡å¼(independent)ã€‚æœ‰ä½•åŒºåˆ«å‘¢ï¼Ÿ

#### å›ºå®šæ¨¡å¼(fixed)

> æ‰€æœ‰åŒ…æ˜¯ç»Ÿä¸€çš„ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å‡çº§ï¼Œæ‰€æœ‰åŒ…ç‰ˆæœ¬ç»Ÿä¸€æ›´æ–°ï¼Œä¸ç®¡è¿™ä¸ªåŒ…å†…å®¹æ”¹å˜ä¸å¦

å…·ä½“ä½“ç°åœ¨ï¼Œ`lerna` çš„é…ç½®æ–‡ä»¶ `lerna.json` ä¸­æ°¸è¿œä¼šå­˜åœ¨ä¸€ä¸ªç¡®å®šç‰ˆæœ¬å·ï¼š

```json
{
  "version": "0.0.1"
}
```

å…¸å‹ä¾‹å­ï¼š `babel`ã€`vue`

#### ç‹¬ç«‹æ¨¡å¼(independent)

> æ¯ä¸ªåŒ…æ˜¯å•ç‹¬çš„ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡ lerna è§¦å‘å‘å¸ƒå‘½ä»¤ï¼Œæ¯ä¸ªåŒ…çš„ç‰ˆæœ¬éƒ½ä¼šå•ç‹¬å˜åŒ–

å…·ä½“ä½“ç°åœ¨ï¼Œ`lerna` çš„é…ç½®æ–‡ä»¶ `lerna.json` ä¸­æ²¡æœ‰ä¸€ä¸ªç¡®å®šç‰ˆæœ¬å·ï¼Œè€Œæ˜¯ï¼š

```json
{
  "version": "independent"
}
```

## Lerna åˆå§‹åŒ–

### å®‰è£…

```bash
$ npm i lerna -g
lerna -v
```

### åˆå§‹åŒ–

ä»£ç ç»“æ„è¦é‡‡ç”¨ `lerna` æä¾›çš„è§„èŒƒç»“æ„çš„è¯ï¼š

```bash
$ cd lerna-pro
# é»˜è®¤æ˜¯ fixed æ¨¡å¼
$ lerna init
# è¦é‡‡ç”¨ independent æ¨¡å¼çš„è¯
$ lerna init -i # lerna init --independent
```

ç”Ÿæˆçš„ç›®å½•ç»“æ„ä¸ºï¼š

```file
â””â”€â”€ lerna-pro/
   â”œâ”€â”€ packages/
   â”œâ”€â”€ lerna.json
   â””â”€â”€ package.json
```

å¦‚æœä»£ç ç»“æ„å·²ç»å­˜åœ¨ï¼Œåˆ™åªéœ€è¦åœ¨æ ¹ç›®å½•ä¸‹æ–°å»º `lerna.json`ï¼Œå¹¶è¡¥å……ç›¸å…³å­—æ®µã€‚

### lerna.json è¯´æ˜

```json
{
  "useWorkspaces": true, // ä½¿ç”¨ workspaces é…ç½®ã€‚æ­¤é¡¹ä¸º true çš„è¯ï¼Œå°†ä½¿ç”¨ package.json çš„ "workspaces"ï¼Œä¸‹é¢çš„ "packages" å­—æ®µå°†ä¸ç”Ÿæ•ˆ
  "version": "0.1.0", // æ‰€æœ‰åŒ…ç‰ˆæœ¬å·ï¼Œç‹¬ç«‹æ¨¡å¼-"independent"
  "npmClient": "cnpm", // npm clientï¼Œå¯è®¾ç½®ä¸º cnpmã€yarn ç­‰
  "packages": [
    // åŒ…æ‰€åœ¨ç›®å½•ï¼Œå¯æŒ‡å®šå¤šä¸ª
    "packages/*"
  ],
  "command": {
    // lerna å‘½ä»¤ç›¸å…³é…ç½®
    "publish": {
      // å‘å¸ƒç›¸å…³
      "ignoreChanges": [
        // æŒ‡å®šæ–‡ä»¶æˆ–ç›®å½•çš„å˜æ›´ï¼Œä¸è§¦å‘ publish
        ".gitignore",
        "*.log",
        "*.md"
      ]
    },
    "bootstrap": {
      // bootstrap ç›¸å…³
      "ignore": "npm-*", // ä¸å— bootstrap å½±å“çš„åŒ…
      "npmClientArgs": [
        // bootstr æ‰§è¡Œå‚æ•°
        "--no-package-lock"
      ]
    }
  }
}
```

## Lerna å‘½ä»¤

> ç®€å•åˆ—ä¸¾ Lerna çš„å‘½ä»¤åŠç”¨å¤„ï¼ŒåŸç‰ˆä»¥åŠæ‰€æœ‰å†…å®¹å¯æŸ¥çœ‹ [lerna.js.org](https://lerna.js.org/)

### Init

```bash
$ lerna init # -i/--independent
```

åˆ›å»ºä¸€ä¸ªæ–°çš„ `lerna` ä»“åº“æˆ–å°†ç°æœ‰çš„ä»“åº“å‡çº§åˆ° `lerna` çš„å½“å‰ç‰ˆæœ¬ã€‚

### Publish

```bash
$ lerna publish # --npm-tag [tagname] | -c | --skip-git | --force-publish [packages]
```

åˆ›å»ºä¸€ä¸ªæ–°ç‰ˆæœ¬çš„åŒ…å·²ç»æ›´æ–°ã€‚æç¤ºè¾“å…¥æ–°ç‰ˆæœ¬å’Œæ›´æ–°æ‰€æœ‰çš„åŒ…åœ¨ `git` å’Œ `npm`ã€‚

### Bootstrap

```bash
$ lerna bootstrap
```

æŠŠæ‰€æœ‰åŒ…çš„ä¾èµ–å®‰è£…åˆ°æ ¹ `node_modules`ã€‚

### Run

```bash
$ lerna run < script > -- [..args]
```

åœ¨æ¯ä¸ªåŒ…é‡Œè¾¹è¿è¡ŒæŒ‡å®šçš„ `script` å‘½ä»¤ã€‚

### Exec

```bash
$ lerna exec -- < command > [..args]
# example
$ lerna exec -- rm -rf ./node_modules
$ lerna exec -- protractor conf.js
```

åœ¨æ¯ä¸ªåŒ…è¿è¡Œä»»æ„å‘½ä»¤ã€‚
